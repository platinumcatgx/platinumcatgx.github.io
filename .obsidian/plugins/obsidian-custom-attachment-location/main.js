/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var __create = Object.create;
var __defProp = Object.defineProperty;
var __getOwnPropDesc = Object.getOwnPropertyDescriptor;
var __getOwnPropNames = Object.getOwnPropertyNames;
var __getProtoOf = Object.getPrototypeOf;
var __hasOwnProp = Object.prototype.hasOwnProperty;
var __markAsModule = (target) => __defProp(target, "__esModule", { value: true });
var __export = (target, all) => {
  __markAsModule(target);
  for (var name in all)
    __defProp(target, name, { get: all[name], enumerable: true });
};
var __reExport = (target, module2, desc) => {
  if (module2 && typeof module2 === "object" || typeof module2 === "function") {
    for (let key of __getOwnPropNames(module2))
      if (!__hasOwnProp.call(target, key) && key !== "default")
        __defProp(target, key, { get: () => module2[key], enumerable: !(desc = __getOwnPropDesc(module2, key)) || desc.enumerable });
  }
  return target;
};
var __toModule = (module2) => {
  return __reExport(__markAsModule(__defProp(module2 != null ? __create(__getProtoOf(module2)) : {}, "default", module2 && module2.__esModule && "default" in module2 ? { get: () => module2.default, enumerable: true } : { value: module2, enumerable: true })), module2);
};
var __async = (__this, __arguments, generator) => {
  return new Promise((resolve, reject) => {
    var fulfilled = (value) => {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    };
    var rejected = (value) => {
      try {
        step(generator.throw(value));
      } catch (e) {
        reject(e);
      }
    };
    var step = (x) => x.done ? resolve(x.value) : Promise.resolve(x.value).then(fulfilled, rejected);
    step((generator = generator.apply(__this, __arguments)).next());
  });
};

// main.ts
__export(exports, {
  default: () => CustomAttachmentLocation
});
var import_obsidian = __toModule(require("obsidian"));
var Path = __toModule(require("path"));
var DEFAULT_SETTINGS = {
  attachmentFolderPath: "assets/${filename}",
  pastedImageFileName: "image-${date}",
  dateTimeFormat: "YYYYMMDDHHmmssSSS",
  autoRenameFolder: true,
  autoRenameFiles: false
};
var originalSettings = {
  attachmentFolderPath: ""
};
var blobToArrayBuffer = (blob) => {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onloadend = () => resolve(reader.result);
    reader.readAsArrayBuffer(blob);
  });
};
var TemplateString = class extends String {
  interpolate(params) {
    const names = Object.keys(params);
    const vals = Object.values(params);
    return new Function(...names, `return \`${this}\`;`)(...vals);
  }
};
var CustomAttachmentLocation = class extends import_obsidian.Plugin {
  constructor() {
    super(...arguments);
    this.useRelativePath = false;
  }
  onload() {
    return __async(this, null, function* () {
      console.log("loading plugin");
      this.adapter = this.app.vault.adapter;
      yield this.loadSettings();
      this.backupConfigs();
      this.addSettingTab(new CustomAttachmentLocationSettingTab(this.app, this));
      this.registerEvent(this.app.workspace.on("editor-paste", this.handlePaste.bind(this)));
      this.registerEvent(this.app.workspace.on("editor-drop", this.handleDrop.bind(this)));
      this.registerEvent(this.app.vault.on("rename", this.handleRename.bind(this)));
    });
  }
  onunload() {
    console.log("unloading plugin");
    this.restoreConfigs();
  }
  loadSettings() {
    return __async(this, null, function* () {
      this.settings = Object.assign({}, DEFAULT_SETTINGS, yield this.loadData());
      if (this.settings.attachmentFolderPath.startsWith("./"))
        this.useRelativePath = true;
      else
        this.useRelativePath = false;
    });
  }
  saveSettings() {
    return __async(this, null, function* () {
      yield this.saveData(this.settings);
    });
  }
  backupConfigs() {
    originalSettings.attachmentFolderPath = this.app.vault.getConfig("attachmentFolderPath");
  }
  restoreConfigs() {
    this.app.vault.setConfig("attachmentFolderPath", originalSettings.attachmentFolderPath);
  }
  updateAttachmentFolderConfig(path) {
    this.app.vault.setConfig("attachmentFolderPath", path);
  }
  getAttachmentFolderPath(mdFileName) {
    let path = new TemplateString(this.settings.attachmentFolderPath).interpolate({
      filename: mdFileName
    });
    return path;
  }
  getAttachmentFolderFullPath(mdFolderPath, mdFileName) {
    let attachmentFolder = "";
    if (this.useRelativePath)
      attachmentFolder = Path.join(mdFolderPath, this.getAttachmentFolderPath(mdFileName));
    else {
      attachmentFolder = this.getAttachmentFolderPath(mdFileName);
    }
    return (0, import_obsidian.normalizePath)(attachmentFolder);
  }
  getPastedImageFileName(mdFileName) {
    let datetime = (0, import_obsidian.moment)().format(this.settings.dateTimeFormat);
    let name = new TemplateString(this.settings.pastedImageFileName).interpolate({
      filename: mdFileName,
      date: datetime
    });
    return name;
  }
  handlePaste(event, editor, view) {
    return __async(this, null, function* () {
      console.log("Handle Paste");
      let mdFileName = view.file.basename;
      let mdFolderPath = Path.dirname(view.file.path);
      let path = this.getAttachmentFolderPath(mdFileName);
      let fullPath = this.getAttachmentFolderFullPath(mdFolderPath, mdFileName);
      this.updateAttachmentFolderConfig(path);
      let clipBoardData = event.clipboardData;
      let clipBoardItems = clipBoardData.items;
      if (!clipBoardData.getData("text/plain")) {
        for (let i in clipBoardItems) {
          if (!clipBoardItems.hasOwnProperty(i))
            continue;
          let item = clipBoardItems[i];
          if (item.kind !== "file")
            continue;
          if (!(item.type === "image/png" || item.type === "image/jpeg"))
            continue;
          let pasteImage = item.getAsFile();
          if (!pasteImage)
            continue;
          let extension = "";
          item.type === "image/png" ? extension = "png" : item.type === "image/jpeg" && (extension = "jpeg");
          event.preventDefault();
          if (!(yield this.adapter.exists(fullPath)))
            yield this.adapter.mkdir(fullPath);
          let img = yield blobToArrayBuffer(pasteImage);
          let name = this.getPastedImageFileName(mdFileName);
          let imageFile = yield this.app.saveAttachment(name, extension, img);
          let markdownLink = yield this.app.fileManager.generateMarkdownLink(imageFile, view.file.path);
          markdownLink += "\n\n";
          editor.replaceSelection(markdownLink);
        }
      }
    });
  }
  handleDrop(event, editor, view) {
    return __async(this, null, function* () {
      console.log("Handle Drop");
      let mdFileName = view.file.basename;
      let mdFolderPath = Path.dirname(view.file.path);
      let path = this.getAttachmentFolderPath(mdFileName);
      let fullPath = this.getAttachmentFolderFullPath(mdFolderPath, mdFileName);
      this.updateAttachmentFolderConfig(path);
      if (!(yield this.adapter.exists(fullPath)))
        yield this.adapter.mkdir(fullPath);
    });
  }
  handleRename(newFile, oldFilePath) {
    return __async(this, null, function* () {
      var _a;
      console.log("Handle Rename");
      if (!this.settings.autoRenameFolder || newFile.extension !== "md")
        return;
      let newName = newFile.basename;
      let oldName = Path.basename(oldFilePath, ".md");
      let mdFolderPath = Path.dirname(newFile.path);
      let oldAttachmentFolderPath = this.getAttachmentFolderFullPath(mdFolderPath, oldName);
      let newAttachmentFolderPath = this.getAttachmentFolderFullPath(mdFolderPath, newName);
      if ((yield this.adapter.exists(oldAttachmentFolderPath)) && oldAttachmentFolderPath !== newAttachmentFolderPath) {
        let tfolder = this.app.vault.getAbstractFileByPath(oldAttachmentFolderPath);
        if (tfolder == null)
          return;
        yield this.app.fileManager.renameFile(tfolder, newAttachmentFolderPath);
        this.updateAttachmentFolderConfig(this.getAttachmentFolderPath(newName));
      }
      if (!this.settings.autoRenameFiles)
        return;
      let embeds = (_a = this.app.metadataCache.getCache(newFile.path)) == null ? void 0 : _a.embeds;
      if (!embeds)
        return;
      let files = [];
      for (let embed of embeds) {
        let link = embed.link;
        if (link.endsWith(".png") || link.endsWith("jpeg"))
          files.push(Path.basename(link));
        else
          continue;
      }
      let attachmentFiles = yield this.adapter.list(newAttachmentFolderPath);
      for (let file of attachmentFiles.files) {
        console.log(file);
        let filePath = file;
        let fileName = Path.basename(filePath);
        if (files.indexOf(fileName) > -1 && fileName.contains(oldName)) {
          fileName = fileName.replace(oldName, newName);
          let newFilePath = (0, import_obsidian.normalizePath)(Path.join(newAttachmentFolderPath, fileName));
          let tfile = this.app.vault.getAbstractFileByPath(filePath);
          yield this.app.fileManager.renameFile(tfile, newFilePath);
        } else
          continue;
      }
    });
  }
};
var CustomAttachmentLocationSettingTab = class extends import_obsidian.PluginSettingTab {
  constructor(app, plugin) {
    super(app, plugin);
    this.plugin = plugin;
  }
  display() {
    let { containerEl } = this;
    containerEl.empty();
    containerEl.createEl("h2", { text: "Custom Attachment Location" });
    let el = new import_obsidian.Setting(containerEl).setName("Location for New Attachments").setDesc('Start with "./" to use relative path. Available variables: ${filename}.(NOTE: DO NOT start with "/" or end with "/". )').addText((text) => text.setPlaceholder("./assets/${filename}").setValue(this.plugin.settings.attachmentFolderPath).onChange((value) => __async(this, null, function* () {
      console.log("attachmentFolder: " + value);
      value = (0, import_obsidian.normalizePath)(value);
      console.log("normalized attachmentFolder: " + value);
      this.plugin.settings.attachmentFolderPath = value;
      if (value.startsWith("./"))
        this.plugin.useRelativePath = true;
      else
        this.plugin.useRelativePath = false;
      yield this.plugin.saveSettings();
    })));
    el.controlEl.addEventListener("change", function() {
      this.display();
    }.bind(this));
    new import_obsidian.Setting(containerEl).setName("Pasted Image Name").setDesc("Available variables: ${filename}, ${date}.").addText((text) => text.setPlaceholder("image-${date}").setValue(this.plugin.settings.pastedImageFileName).onChange((value) => __async(this, null, function* () {
      console.log("pastedImageFileName: " + value);
      this.plugin.settings.pastedImageFileName = value;
      yield this.plugin.saveSettings();
    })));
    new import_obsidian.Setting(containerEl).setName("Date Format").setDesc("YYYYMMDDHHmmssSSS").addMomentFormat((text) => text.setDefaultFormat("YYYYMMDDHHmmssSSS").setValue(this.plugin.settings.dateTimeFormat).onChange((value) => __async(this, null, function* () {
      console.log("dateTimeFormat: " + value);
      this.plugin.settings.dateTimeFormat = value || "YYYYMMDDHHmmssSSS";
      yield this.plugin.saveSettings();
    })));
    new import_obsidian.Setting(containerEl).setName("Automatically rename attachment folder").setDesc('When renaming md files, automatically rename attachment folder if fodler name contains "${filename}".').addToggle((toggle) => toggle.setValue(this.plugin.settings.autoRenameFolder).onChange((value) => __async(this, null, function* () {
      this.plugin.settings.autoRenameFolder = value;
      this.display();
      yield this.plugin.saveSettings();
    })));
    if (this.plugin.settings.autoRenameFolder)
      new import_obsidian.Setting(containerEl).setName("Automatically rename attachment files [Experimental]").setDesc('When renaming md files, automatically rename attachment files if file name contains "${filename}".').addToggle((toggle) => toggle.setValue(this.plugin.settings.autoRenameFiles).onChange((value) => __async(this, null, function* () {
        this.plugin.settings.autoRenameFiles = value;
        yield this.plugin.saveSettings();
      })));
  }
};
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsibWFpbi50cyJdLAogICJzb3VyY2VzQ29udGVudCI6IFsiaW1wb3J0IHsgQXBwLCBFZGl0b3IsIE1hcmtkb3duVmlldywgUGx1Z2luLCBQbHVnaW5TZXR0aW5nVGFiLCBTZXR0aW5nLCBtb21lbnQsIG5vcm1hbGl6ZVBhdGgsIFRBYnN0cmFjdEZpbGUsIEZpbGVTeXN0ZW1BZGFwdGVyLCBMaXN0ZWRGaWxlcywgVEZpbGUgfSBmcm9tICdvYnNpZGlhbic7XHJcbmltcG9ydCAqIGFzIFBhdGggZnJvbSAncGF0aCc7XHJcbmltcG9ydCB7IGJhc2VuYW1lIH0gZnJvbSAncGF0aC9wb3NpeCc7XHJcbmltcG9ydCB7IHRocmVhZElkIH0gZnJvbSAnd29ya2VyX3RocmVhZHMnO1xyXG5cclxuaW50ZXJmYWNlIEN1c3RvbUF0dGFjaG1lbnRMb2NhdGlvblNldHRpbmdzIHtcclxuICAgIGF0dGFjaG1lbnRGb2xkZXJQYXRoOiBzdHJpbmc7XHJcbiAgICBwYXN0ZWRJbWFnZUZpbGVOYW1lOiBzdHJpbmc7XHJcbiAgICBkYXRlVGltZUZvcm1hdDogc3RyaW5nO1xyXG4gICAgYXV0b1JlbmFtZUZvbGRlcjogYm9vbGVhbjtcclxuICAgIGF1dG9SZW5hbWVGaWxlczogYm9vbGVhbjtcclxufVxyXG5cclxuY29uc3QgREVGQVVMVF9TRVRUSU5HUzogQ3VzdG9tQXR0YWNobWVudExvY2F0aW9uU2V0dGluZ3MgPSB7XHJcbiAgICBhdHRhY2htZW50Rm9sZGVyUGF0aDogJ2Fzc2V0cy8ke2ZpbGVuYW1lfScsXHJcbiAgICBwYXN0ZWRJbWFnZUZpbGVOYW1lOiAnaW1hZ2UtJHtkYXRlfScsXHJcbiAgICBkYXRlVGltZUZvcm1hdDogJ1lZWVlNTURESEhtbXNzU1NTJyxcclxuICAgIGF1dG9SZW5hbWVGb2xkZXI6IHRydWUsXHJcbiAgICBhdXRvUmVuYW1lRmlsZXM6IGZhbHNlXHJcbn1cclxuXHJcbmxldCBvcmlnaW5hbFNldHRpbmdzID0ge1xyXG4gICAgYXR0YWNobWVudEZvbGRlclBhdGg6ICcnXHJcbn07XHJcblxyXG5jb25zdCBibG9iVG9BcnJheUJ1ZmZlciA9IChibG9iOiBCbG9iKSA9PiB7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcclxuICAgICAgY29uc3QgcmVhZGVyID0gbmV3IEZpbGVSZWFkZXIoKVxyXG4gICAgICByZWFkZXIub25sb2FkZW5kID0gKCkgPT4gcmVzb2x2ZShyZWFkZXIucmVzdWx0KVxyXG4gICAgICByZWFkZXIucmVhZEFzQXJyYXlCdWZmZXIoYmxvYilcclxuICAgIH0pXHJcbn1cclxuXHJcblxyXG5jbGFzcyBUZW1wbGF0ZVN0cmluZyBleHRlbmRzIFN0cmluZ3tcclxuICAgIGludGVycG9sYXRlKHBhcmFtczogT2JqZWN0KSB7XHJcbiAgICAgICAgY29uc3QgbmFtZXMgPSBPYmplY3Qua2V5cyhwYXJhbXMpO1xyXG4gICAgICAgIGNvbnN0IHZhbHMgPSBPYmplY3QudmFsdWVzKHBhcmFtcyk7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBGdW5jdGlvbiguLi5uYW1lcywgYHJldHVybiBcXGAke3RoaXN9XFxgO2ApKC4uLnZhbHMpO1xyXG4gICAgfVxyXG59XHJcblxyXG5cclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQ3VzdG9tQXR0YWNobWVudExvY2F0aW9uIGV4dGVuZHMgUGx1Z2luIHtcclxuICAgIHNldHRpbmdzOiBDdXN0b21BdHRhY2htZW50TG9jYXRpb25TZXR0aW5ncztcclxuICAgIHVzZVJlbGF0aXZlUGF0aDogYm9vbGVhbiA9IGZhbHNlO1xyXG4gICAgYWRhcHRlcjogRmlsZVN5c3RlbUFkYXB0ZXI7XHJcblxyXG4gICAgYXN5bmMgb25sb2FkKCkge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKCdsb2FkaW5nIHBsdWdpbicpO1xyXG5cclxuICAgICAgICB0aGlzLmFkYXB0ZXIgPSB0aGlzLmFwcC52YXVsdC5hZGFwdGVyIGFzIEZpbGVTeXN0ZW1BZGFwdGVyO1xyXG4gICAgICAgIGF3YWl0IHRoaXMubG9hZFNldHRpbmdzKCk7XHJcbiAgICAgICAgdGhpcy5iYWNrdXBDb25maWdzKCk7XHJcblxyXG4gICAgICAgIHRoaXMuYWRkU2V0dGluZ1RhYihuZXcgQ3VzdG9tQXR0YWNobWVudExvY2F0aW9uU2V0dGluZ1RhYih0aGlzLmFwcCwgdGhpcykpO1xyXG4gICAgICAgIC8qXHJcbiAgICAgICAgICAgIGJpbmQgdGhpcyBwb2ludGVyIHRvIGhhbmRsZVBhc3RlXHJcbiAgICAgICAgICAgIHRoaXMucmVnaXN0ZXJFdmVudCh0aGlzLmFwcC53b3Jrc3BhY2Uub24oJ2VkaXRvci1wYXN0ZScsIHRoaXMuaGFuZGxlUGFzdGUpKTtcclxuICAgICAgICAqL1xyXG4gICAgICAgIHRoaXMucmVnaXN0ZXJFdmVudCh0aGlzLmFwcC53b3Jrc3BhY2Uub24oJ2VkaXRvci1wYXN0ZScsIHRoaXMuaGFuZGxlUGFzdGUuYmluZCh0aGlzKSkpO1xyXG4gICAgICAgIHRoaXMucmVnaXN0ZXJFdmVudCh0aGlzLmFwcC53b3Jrc3BhY2Uub24oJ2VkaXRvci1kcm9wJywgdGhpcy5oYW5kbGVEcm9wLmJpbmQodGhpcykpKTtcclxuICAgICAgICB0aGlzLnJlZ2lzdGVyRXZlbnQodGhpcy5hcHAudmF1bHQub24oJ3JlbmFtZScsIHRoaXMuaGFuZGxlUmVuYW1lLmJpbmQodGhpcykpKTtcclxuICAgIH1cclxuXHJcbiAgICBvbnVubG9hZCgpIHtcclxuICAgICAgICBjb25zb2xlLmxvZygndW5sb2FkaW5nIHBsdWdpbicpO1xyXG4gICAgICAgIHRoaXMucmVzdG9yZUNvbmZpZ3MoKTtcclxuICAgIH1cclxuXHJcbiAgICBhc3luYyBsb2FkU2V0dGluZ3MoKSB7XHJcbiAgICAgICAgdGhpcy5zZXR0aW5ncyA9IE9iamVjdC5hc3NpZ24oe30sIERFRkFVTFRfU0VUVElOR1MsIGF3YWl0IHRoaXMubG9hZERhdGEoKSk7XHJcbiAgICAgICAgaWYodGhpcy5zZXR0aW5ncy5hdHRhY2htZW50Rm9sZGVyUGF0aC5zdGFydHNXaXRoKCcuLycpKVxyXG4gICAgICAgICAgICB0aGlzLnVzZVJlbGF0aXZlUGF0aCA9IHRydWU7XHJcbiAgICAgICAgZWxzZVxyXG4gICAgICAgICAgICB0aGlzLnVzZVJlbGF0aXZlUGF0aCA9IGZhbHNlO1xyXG4gICAgfVxyXG5cclxuICAgIGFzeW5jIHNhdmVTZXR0aW5ncygpIHtcclxuICAgICAgICBhd2FpdCB0aGlzLnNhdmVEYXRhKHRoaXMuc2V0dGluZ3MpO1xyXG4gICAgfVxyXG5cclxuICAgIGJhY2t1cENvbmZpZ3MoKXtcclxuICAgICAgICAvL0B0cy1pZ25vcmVcclxuICAgICAgICBvcmlnaW5hbFNldHRpbmdzLmF0dGFjaG1lbnRGb2xkZXJQYXRoID0gdGhpcy5hcHAudmF1bHQuZ2V0Q29uZmlnKCdhdHRhY2htZW50Rm9sZGVyUGF0aCcpO1xyXG4gICAgfVxyXG5cclxuICAgIHJlc3RvcmVDb25maWdzKCl7XHJcbiAgICAgICAgLy9AdHMtaWdub3JlXHJcbiAgICAgICAgdGhpcy5hcHAudmF1bHQuc2V0Q29uZmlnKCdhdHRhY2htZW50Rm9sZGVyUGF0aCcsIG9yaWdpbmFsU2V0dGluZ3MuYXR0YWNobWVudEZvbGRlclBhdGgpO1xyXG4gICAgfVxyXG5cclxuICAgIHVwZGF0ZUF0dGFjaG1lbnRGb2xkZXJDb25maWcocGF0aDogc3RyaW5nKVxyXG4gICAge1xyXG4gICAgICAgIC8vQHRzLWlnbm9yZVxyXG4gICAgICAgIHRoaXMuYXBwLnZhdWx0LnNldENvbmZpZygnYXR0YWNobWVudEZvbGRlclBhdGgnLCBwYXRoKTtcclxuICAgIH1cclxuXHJcbiAgICBnZXRBdHRhY2htZW50Rm9sZGVyUGF0aChtZEZpbGVOYW1lOiBzdHJpbmcpXHJcbiAgICB7XHJcbiAgICAgICAgbGV0IHBhdGggPSBuZXcgVGVtcGxhdGVTdHJpbmcodGhpcy5zZXR0aW5ncy5hdHRhY2htZW50Rm9sZGVyUGF0aCkuaW50ZXJwb2xhdGUoe1xyXG4gICAgICAgICAgICBmaWxlbmFtZTogbWRGaWxlTmFtZVxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHJldHVybiBwYXRoO1xyXG4gICAgfVxyXG5cclxuICAgIGdldEF0dGFjaG1lbnRGb2xkZXJGdWxsUGF0aChtZEZvbGRlclBhdGg6IHN0cmluZywgbWRGaWxlTmFtZTogc3RyaW5nKVxyXG4gICAge1xyXG4gICAgICAgIGxldCBhdHRhY2htZW50Rm9sZGVyID0gJyc7XHJcbiAgICAgICAgXHJcbiAgICAgICAgaWYodGhpcy51c2VSZWxhdGl2ZVBhdGgpXHJcbiAgICAgICAgICAgIGF0dGFjaG1lbnRGb2xkZXIgPSBQYXRoLmpvaW4obWRGb2xkZXJQYXRoLCB0aGlzLmdldEF0dGFjaG1lbnRGb2xkZXJQYXRoKG1kRmlsZU5hbWUpKTtcclxuICAgICAgICBlbHNlXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgICBhdHRhY2htZW50Rm9sZGVyID0gdGhpcy5nZXRBdHRhY2htZW50Rm9sZGVyUGF0aChtZEZpbGVOYW1lKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIG5vcm1hbGl6ZVBhdGgoYXR0YWNobWVudEZvbGRlcik7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0UGFzdGVkSW1hZ2VGaWxlTmFtZShtZEZpbGVOYW1lOiBzdHJpbmcpXHJcbiAgICB7XHJcbiAgICAgICAgbGV0IGRhdGV0aW1lID0gbW9tZW50KCkuZm9ybWF0KHRoaXMuc2V0dGluZ3MuZGF0ZVRpbWVGb3JtYXQpO1xyXG4gICAgICAgIGxldCBuYW1lID0gbmV3IFRlbXBsYXRlU3RyaW5nKHRoaXMuc2V0dGluZ3MucGFzdGVkSW1hZ2VGaWxlTmFtZSkuaW50ZXJwb2xhdGUoe1xyXG4gICAgICAgICAgICBmaWxlbmFtZTogbWRGaWxlTmFtZSxcclxuICAgICAgICAgICAgZGF0ZTogZGF0ZXRpbWVcclxuICAgICAgICB9KTtcclxuICAgICAgICByZXR1cm4gbmFtZTtcclxuICAgIH1cclxuXHJcblxyXG4gICAgYXN5bmMgaGFuZGxlUGFzdGUoZXZlbnQ6IENsaXBib2FyZEV2ZW50LCBlZGl0b3I6IEVkaXRvciwgdmlldzogTWFya2Rvd25WaWV3KXtcclxuICAgICAgICBjb25zb2xlLmxvZygnSGFuZGxlIFBhc3RlJyk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgbGV0IG1kRmlsZU5hbWUgPSB2aWV3LmZpbGUuYmFzZW5hbWU7XHJcbiAgICAgICAgbGV0IG1kRm9sZGVyUGF0aDogc3RyaW5nID0gUGF0aC5kaXJuYW1lKHZpZXcuZmlsZS5wYXRoKTtcclxuXHJcbiAgICAgICAgbGV0IHBhdGggPSB0aGlzLmdldEF0dGFjaG1lbnRGb2xkZXJQYXRoKG1kRmlsZU5hbWUpO1xyXG4gICAgICAgIGxldCBmdWxsUGF0aCA9IHRoaXMuZ2V0QXR0YWNobWVudEZvbGRlckZ1bGxQYXRoKG1kRm9sZGVyUGF0aCwgbWRGaWxlTmFtZSk7XHJcblxyXG4gICAgICAgIHRoaXMudXBkYXRlQXR0YWNobWVudEZvbGRlckNvbmZpZyhwYXRoKTtcclxuICAgICAgICAvLyB0aGlzLmFwcC52YXVsdC5zZXRDb25maWcoJ2F0dGFjaG1lbnRGb2xkZXJQYXRoJywgYC4vYXNzZXRzLyR7ZmlsZW5hbWV9YCk7XHJcblxyXG4gICAgICAgIGxldCBjbGlwQm9hcmREYXRhID0gZXZlbnQuY2xpcGJvYXJkRGF0YTtcclxuICAgICAgICBsZXQgY2xpcEJvYXJkSXRlbXMgPSBjbGlwQm9hcmREYXRhLml0ZW1zO1xyXG4gICAgICAgIGlmKCFjbGlwQm9hcmREYXRhLmdldERhdGEoJ3RleHQvcGxhaW4nKSl7XHJcbiAgICAgICAgICAgIGZvcihsZXQgaSBpbiBjbGlwQm9hcmRJdGVtcyl7XHJcbiAgICAgICAgICAgICAgICBpZighY2xpcEJvYXJkSXRlbXMuaGFzT3duUHJvcGVydHkoaSkpXHJcbiAgICAgICAgICAgICAgICAgICAgY29udGludWU7XHJcbiAgICAgICAgICAgICAgICBsZXQgaXRlbSA9IGNsaXBCb2FyZEl0ZW1zW2ldO1xyXG4gICAgICAgICAgICAgICAgaWYoaXRlbS5raW5kICE9PSAnZmlsZScpXHJcbiAgICAgICAgICAgICAgICAgICAgY29udGludWU7XHJcbiAgICAgICAgICAgICAgICBpZighKGl0ZW0udHlwZSA9PT0gJ2ltYWdlL3BuZycgfHwgaXRlbS50eXBlID09PSAnaW1hZ2UvanBlZycpKVxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICBsZXQgcGFzdGVJbWFnZSA9IGl0ZW0uZ2V0QXNGaWxlKCk7XHJcbiAgICAgICAgICAgICAgICBpZighcGFzdGVJbWFnZSlcclxuICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgIGxldCBleHRlbnNpb24gPSAnJztcclxuICAgICAgICAgICAgICAgIGl0ZW0udHlwZSA9PT0gJ2ltYWdlL3BuZycgPyBleHRlbnNpb24gPSAncG5nJyA6IGl0ZW0udHlwZSA9PT0gJ2ltYWdlL2pwZWcnICYmIChleHRlbnNpb24gPSAnanBlZycpO1xyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG5cclxuICAgICAgICAgICAgICAgIC8vaWYgZm9sZGVyIG5vdCBleGlzdCwgbWtkaXIgZmlyc3QuXHJcbiAgICAgICAgICAgICAgICBpZighYXdhaXQgdGhpcy5hZGFwdGVyLmV4aXN0cyhmdWxsUGF0aCkpXHJcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5hZGFwdGVyLm1rZGlyKGZ1bGxQYXRoKTtcclxuXHJcbiAgICAgICAgICAgICAgICBsZXQgaW1nID0gYXdhaXQgYmxvYlRvQXJyYXlCdWZmZXIocGFzdGVJbWFnZSk7XHJcbiAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgIGxldCBuYW1lID0gdGhpcy5nZXRQYXN0ZWRJbWFnZUZpbGVOYW1lKG1kRmlsZU5hbWUpO1xyXG4gICAgICAgICAgICAgICAgLy8gbGV0IG5hbWUgPSAnaW1hZ2UtJyArIG1vbWVudCgpLmZvcm1hdCgnWVlZWU1NRERISG1tc3NTU1MnKTtcclxuICAgICAgICAgICAgICAgIFxyXG5cclxuICAgICAgICAgICAgICAgIC8vQHRzLWlnbm9yZVxyXG4gICAgICAgICAgICAgICAgbGV0IGltYWdlRmlsZSA9IGF3YWl0IHRoaXMuYXBwLnNhdmVBdHRhY2htZW50KG5hbWUsIGV4dGVuc2lvbiwgaW1nKTtcclxuICAgICAgICAgICAgICAgIGxldCBtYXJrZG93bkxpbmsgPSBhd2FpdCB0aGlzLmFwcC5maWxlTWFuYWdlci5nZW5lcmF0ZU1hcmtkb3duTGluayhpbWFnZUZpbGUsIHZpZXcuZmlsZS5wYXRoKTtcclxuICAgICAgICAgICAgICAgIG1hcmtkb3duTGluayArPSAnXFxuXFxuJztcclxuICAgICAgICAgICAgICAgIGVkaXRvci5yZXBsYWNlU2VsZWN0aW9uKG1hcmtkb3duTGluayk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgYXN5bmMgaGFuZGxlRHJvcChldmVudDogRHJhZ0V2ZW50LCBlZGl0b3I6IEVkaXRvciwgdmlldzogTWFya2Rvd25WaWV3KXtcclxuICAgICAgICBjb25zb2xlLmxvZygnSGFuZGxlIERyb3AnKTtcclxuICAgICAgICBcclxuICAgICAgICBsZXQgbWRGaWxlTmFtZSA9IHZpZXcuZmlsZS5iYXNlbmFtZTtcclxuICAgICAgICBsZXQgbWRGb2xkZXJQYXRoOiBzdHJpbmcgPSBQYXRoLmRpcm5hbWUodmlldy5maWxlLnBhdGgpO1xyXG5cclxuICAgICAgICBsZXQgcGF0aCA9IHRoaXMuZ2V0QXR0YWNobWVudEZvbGRlclBhdGgobWRGaWxlTmFtZSk7XHJcbiAgICAgICAgbGV0IGZ1bGxQYXRoID0gdGhpcy5nZXRBdHRhY2htZW50Rm9sZGVyRnVsbFBhdGgobWRGb2xkZXJQYXRoLCBtZEZpbGVOYW1lKTtcclxuXHJcbiAgICAgICAgdGhpcy51cGRhdGVBdHRhY2htZW50Rm9sZGVyQ29uZmlnKHBhdGgpO1xyXG5cclxuICAgICAgICBpZighYXdhaXQgdGhpcy5hZGFwdGVyLmV4aXN0cyhmdWxsUGF0aCkpXHJcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuYWRhcHRlci5ta2RpcihmdWxsUGF0aCk7XHJcbiAgICB9XHJcblxyXG4gICAgYXN5bmMgaGFuZGxlUmVuYW1lKG5ld0ZpbGU6IFRGaWxlLCBvbGRGaWxlUGF0aDogc3RyaW5nKXtcclxuICAgICAgICBjb25zb2xlLmxvZygnSGFuZGxlIFJlbmFtZScpO1xyXG5cclxuICAgICAgICAvL2lmIGF1dG9SZW5hbWUgaXMgb2ZmIG9yIG5vdCBhIG1hcmtkb3duIGZpbGVcclxuICAgICAgICBpZighdGhpcy5zZXR0aW5ncy5hdXRvUmVuYW1lRm9sZGVyIHx8IG5ld0ZpbGUuZXh0ZW5zaW9uICE9PSAnbWQnKVxyXG4gICAgICAgICAgICByZXR1cm47XHJcblxyXG4gICAgICAgIGxldCBuZXdOYW1lID0gbmV3RmlsZS5iYXNlbmFtZTtcclxuXHJcbiAgICAgICAgbGV0IG9sZE5hbWUgPSBQYXRoLmJhc2VuYW1lKG9sZEZpbGVQYXRoLCAnLm1kJyk7XHJcblxyXG4gICAgICAgIGxldCBtZEZvbGRlclBhdGg6IHN0cmluZyA9IFBhdGguZGlybmFtZShuZXdGaWxlLnBhdGgpO1xyXG4gICAgICAgIGxldCBvbGRBdHRhY2htZW50Rm9sZGVyUGF0aDogc3RyaW5nID0gdGhpcy5nZXRBdHRhY2htZW50Rm9sZGVyRnVsbFBhdGgobWRGb2xkZXJQYXRoLCBvbGROYW1lKTtcclxuICAgICAgICBsZXQgbmV3QXR0YWNobWVudEZvbGRlclBhdGg6IHN0cmluZyA9IHRoaXMuZ2V0QXR0YWNobWVudEZvbGRlckZ1bGxQYXRoKG1kRm9sZGVyUGF0aCwgbmV3TmFtZSk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgLy9jaGVjayBpZiBvbGQgYXR0YWNobWVudCBmb2xkZXIgZXhpc3RzIGFuZCBpcyBuZWNlc3NhcnkgdG8gcmVuYW1lIEZvbGRlclxyXG4gICAgICAgIGlmKGF3YWl0IHRoaXMuYWRhcHRlci5leGlzdHMob2xkQXR0YWNobWVudEZvbGRlclBhdGgpICYmIChvbGRBdHRhY2htZW50Rm9sZGVyUGF0aCAhPT0gbmV3QXR0YWNobWVudEZvbGRlclBhdGgpKVxyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgbGV0IHRmb2xkZXI6IFRBYnN0cmFjdEZpbGUgPSB0aGlzLmFwcC52YXVsdC5nZXRBYnN0cmFjdEZpbGVCeVBhdGgob2xkQXR0YWNobWVudEZvbGRlclBhdGgpO1xyXG5cclxuICAgICAgICAgICAgaWYodGZvbGRlciA9PSBudWxsKVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBhd2FpdCB0aGlzLmFwcC5maWxlTWFuYWdlci5yZW5hbWVGaWxlKHRmb2xkZXIsIG5ld0F0dGFjaG1lbnRGb2xkZXJQYXRoKTsgICAgIFxyXG4gICAgICAgICAgICB0aGlzLnVwZGF0ZUF0dGFjaG1lbnRGb2xkZXJDb25maWcodGhpcy5nZXRBdHRhY2htZW50Rm9sZGVyUGF0aChuZXdOYW1lKSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvL2lmIGF1dG9SZW5hbWVGaWxlcyBpcyBvZmZcclxuICAgICAgICBpZighdGhpcy5zZXR0aW5ncy5hdXRvUmVuYW1lRmlsZXMpXHJcbiAgICAgICAgICAgIHJldHVybjtcclxuXHJcbiAgICAgICAgbGV0IGVtYmVkcyA9IHRoaXMuYXBwLm1ldGFkYXRhQ2FjaGUuZ2V0Q2FjaGUobmV3RmlsZS5wYXRoKT8uZW1iZWRzO1xyXG4gICAgICAgIGlmKCFlbWJlZHMpXHJcbiAgICAgICAgICAgIHJldHVybjtcclxuXHJcbiAgICAgICAgbGV0IGZpbGVzOiBzdHJpbmdbXSA9IFtdO1xyXG5cclxuICAgICAgICBmb3IobGV0IGVtYmVkIG9mIGVtYmVkcylcclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIGxldCBsaW5rID0gZW1iZWQubGluaztcclxuICAgICAgICAgICAgaWYobGluay5lbmRzV2l0aCgnLnBuZycpIHx8IGxpbmsuZW5kc1dpdGgoJ2pwZWcnKSlcclxuICAgICAgICAgICAgICAgIGZpbGVzLnB1c2goUGF0aC5iYXNlbmFtZShsaW5rKSk7XHJcbiAgICAgICAgICAgIGVsc2VcclxuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xyXG5cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGxldCBhdHRhY2htZW50RmlsZXM6IExpc3RlZEZpbGVzPSBhd2FpdCB0aGlzLmFkYXB0ZXIubGlzdChuZXdBdHRhY2htZW50Rm9sZGVyUGF0aCk7XHJcbiAgICAgICAgZm9yKGxldCBmaWxlIG9mIGF0dGFjaG1lbnRGaWxlcy5maWxlcylcclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGZpbGUpO1xyXG4gICAgICAgICAgICBsZXQgZmlsZVBhdGggPSBmaWxlO1xyXG4gICAgICAgICAgICBsZXQgZmlsZU5hbWUgPSBQYXRoLmJhc2VuYW1lKGZpbGVQYXRoKTtcclxuICAgICAgICAgICAgaWYoKGZpbGVzLmluZGV4T2YoZmlsZU5hbWUpID4gLTEpICYmIGZpbGVOYW1lLmNvbnRhaW5zKG9sZE5hbWUpKVxyXG4gICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICBmaWxlTmFtZSA9IGZpbGVOYW1lLnJlcGxhY2Uob2xkTmFtZSwgbmV3TmFtZSk7XHJcbiAgICAgICAgICAgICAgICBsZXQgbmV3RmlsZVBhdGggPSBub3JtYWxpemVQYXRoKFBhdGguam9pbihuZXdBdHRhY2htZW50Rm9sZGVyUGF0aCwgZmlsZU5hbWUpKTtcclxuICAgICAgICAgICAgICAgIGxldCB0ZmlsZSA9IHRoaXMuYXBwLnZhdWx0LmdldEFic3RyYWN0RmlsZUJ5UGF0aChmaWxlUGF0aCk7XHJcbiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLmFwcC5maWxlTWFuYWdlci5yZW5hbWVGaWxlKHRmaWxlLCBuZXdGaWxlUGF0aCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZVxyXG4gICAgICAgICAgICAgICAgY29udGludWU7IFxyXG4gICAgICAgIH1cclxuICAgIH1cclxufVxyXG5cclxuY2xhc3MgQ3VzdG9tQXR0YWNobWVudExvY2F0aW9uU2V0dGluZ1RhYiBleHRlbmRzIFBsdWdpblNldHRpbmdUYWIge1xyXG4gICAgcGx1Z2luOiBDdXN0b21BdHRhY2htZW50TG9jYXRpb247XHJcblxyXG4gICAgY29uc3RydWN0b3IoYXBwOiBBcHAsIHBsdWdpbjogQ3VzdG9tQXR0YWNobWVudExvY2F0aW9uKSB7XHJcbiAgICAgICAgc3VwZXIoYXBwLCBwbHVnaW4pO1xyXG4gICAgICAgIHRoaXMucGx1Z2luID0gcGx1Z2luO1xyXG4gICAgfVxyXG5cclxuICAgIGRpc3BsYXkoKTogdm9pZCB7XHJcbiAgICAgICAgbGV0IHtjb250YWluZXJFbH0gPSB0aGlzO1xyXG5cclxuICAgICAgICBjb250YWluZXJFbC5lbXB0eSgpO1xyXG5cclxuICAgICAgICBjb250YWluZXJFbC5jcmVhdGVFbCgnaDInLCB7dGV4dDogJ0N1c3RvbSBBdHRhY2htZW50IExvY2F0aW9uJ30pO1xyXG5cclxuICAgICAgICBsZXQgZWwgPSBuZXcgU2V0dGluZyhjb250YWluZXJFbClcclxuICAgICAgICAgICAgLnNldE5hbWUoJ0xvY2F0aW9uIGZvciBOZXcgQXR0YWNobWVudHMnKVxyXG4gICAgICAgICAgICAuc2V0RGVzYygnU3RhcnQgd2l0aCBcIi4vXCIgdG8gdXNlIHJlbGF0aXZlIHBhdGguIEF2YWlsYWJsZSB2YXJpYWJsZXM6ICR7ZmlsZW5hbWV9LihOT1RFOiBETyBOT1Qgc3RhcnQgd2l0aCBcIi9cIiBvciBlbmQgd2l0aCBcIi9cIi4gKScpXHJcbiAgICAgICAgICAgIC5hZGRUZXh0KHRleHQgPT4gdGV4dFxyXG4gICAgICAgICAgICAgICAgLnNldFBsYWNlaG9sZGVyKCcuL2Fzc2V0cy8ke2ZpbGVuYW1lfScpXHJcbiAgICAgICAgICAgICAgICAuc2V0VmFsdWUodGhpcy5wbHVnaW4uc2V0dGluZ3MuYXR0YWNobWVudEZvbGRlclBhdGgpXHJcbiAgICAgICAgICAgICAgICAub25DaGFuZ2UoYXN5bmMgKHZhbHVlOiBzdHJpbmcpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnYXR0YWNobWVudEZvbGRlcjogJyArIHZhbHVlKTtcclxuICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IG5vcm1hbGl6ZVBhdGgodmFsdWUpO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdub3JtYWxpemVkIGF0dGFjaG1lbnRGb2xkZXI6ICcgKyB2YWx1ZSk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMucGx1Z2luLnNldHRpbmdzLmF0dGFjaG1lbnRGb2xkZXJQYXRoID0gdmFsdWU7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYodmFsdWUuc3RhcnRzV2l0aCgnLi8nKSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wbHVnaW4udXNlUmVsYXRpdmVQYXRoID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICBlbHNlXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGx1Z2luLnVzZVJlbGF0aXZlUGF0aCA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMucGx1Z2luLnNhdmVTZXR0aW5ncygpO1xyXG4gICAgICAgICAgICAgICAgfSkpO1xyXG4gICAgICAgIGVsLmNvbnRyb2xFbC5hZGRFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCAgZnVuY3Rpb24oKXt0aGlzLmRpc3BsYXkoKX0uYmluZCh0aGlzKSk7XHJcbiAgICAgICAgXHJcblxyXG4gICAgICAgIG5ldyBTZXR0aW5nKGNvbnRhaW5lckVsKVxyXG4gICAgICAgICAgICAuc2V0TmFtZSgnUGFzdGVkIEltYWdlIE5hbWUnKVxyXG4gICAgICAgICAgICAuc2V0RGVzYygnQXZhaWxhYmxlIHZhcmlhYmxlczogJHtmaWxlbmFtZX0sICR7ZGF0ZX0uJylcclxuICAgICAgICAgICAgLmFkZFRleHQodGV4dCA9PiB0ZXh0XHJcbiAgICAgICAgICAgICAgICAuc2V0UGxhY2Vob2xkZXIoJ2ltYWdlLSR7ZGF0ZX0nKVxyXG4gICAgICAgICAgICAgICAgLnNldFZhbHVlKHRoaXMucGx1Z2luLnNldHRpbmdzLnBhc3RlZEltYWdlRmlsZU5hbWUpXHJcbiAgICAgICAgICAgICAgICAub25DaGFuZ2UoYXN5bmMgKHZhbHVlOiBzdHJpbmcpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygncGFzdGVkSW1hZ2VGaWxlTmFtZTogJyArIHZhbHVlKTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnBsdWdpbi5zZXR0aW5ncy5wYXN0ZWRJbWFnZUZpbGVOYW1lID0gdmFsdWU7XHJcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5wbHVnaW4uc2F2ZVNldHRpbmdzKCk7XHJcbiAgICAgICAgICAgICAgICB9KSk7XHJcblxyXG4gICAgICAgIG5ldyBTZXR0aW5nKGNvbnRhaW5lckVsKVxyXG4gICAgICAgICAgICAuc2V0TmFtZSgnRGF0ZSBGb3JtYXQnKVxyXG4gICAgICAgICAgICAuc2V0RGVzYygnWVlZWU1NRERISG1tc3NTU1MnKVxyXG4gICAgICAgICAgICAuYWRkTW9tZW50Rm9ybWF0KHRleHQgPT4gdGV4dFxyXG4gICAgICAgICAgICAgICAgLnNldERlZmF1bHRGb3JtYXQoJ1lZWVlNTURESEhtbXNzU1NTJylcclxuICAgICAgICAgICAgICAgIC5zZXRWYWx1ZSh0aGlzLnBsdWdpbi5zZXR0aW5ncy5kYXRlVGltZUZvcm1hdClcclxuICAgICAgICAgICAgICAgIC5vbkNoYW5nZShhc3luYyAodmFsdWU6IHN0cmluZykgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdkYXRlVGltZUZvcm1hdDogJyArIHZhbHVlKTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnBsdWdpbi5zZXR0aW5ncy5kYXRlVGltZUZvcm1hdCA9IHZhbHVlIHx8ICdZWVlZTU1EREhIbW1zc1NTUyc7XHJcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5wbHVnaW4uc2F2ZVNldHRpbmdzKCk7XHJcbiAgICAgICAgICAgICAgICB9KSk7XHJcblxyXG4gICAgICAgIFxyXG4gICAgICAgIG5ldyBTZXR0aW5nKGNvbnRhaW5lckVsKVxyXG4gICAgICAgICAgICAuc2V0TmFtZSgnQXV0b21hdGljYWxseSByZW5hbWUgYXR0YWNobWVudCBmb2xkZXInKVxyXG4gICAgICAgICAgICAuc2V0RGVzYygnV2hlbiByZW5hbWluZyBtZCBmaWxlcywgYXV0b21hdGljYWxseSByZW5hbWUgYXR0YWNobWVudCBmb2xkZXIgaWYgZm9kbGVyIG5hbWUgY29udGFpbnMgXCIke2ZpbGVuYW1lfVwiLicpXHJcbiAgICAgICAgICAgIC5hZGRUb2dnbGUodG9nZ2xlID0+IHRvZ2dsZVxyXG4gICAgICAgICAgICAgICAgLnNldFZhbHVlKHRoaXMucGx1Z2luLnNldHRpbmdzLmF1dG9SZW5hbWVGb2xkZXIpXHJcbiAgICAgICAgICAgICAgICAub25DaGFuZ2UoYXN5bmMgKHZhbHVlOiBib29sZWFuKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5wbHVnaW4uc2V0dGluZ3MuYXV0b1JlbmFtZUZvbGRlciA9IHZhbHVlO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZGlzcGxheSgpO1xyXG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMucGx1Z2luLnNhdmVTZXR0aW5ncygpO1xyXG4gICAgICAgICAgICAgICAgfSkpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGlmKHRoaXMucGx1Z2luLnNldHRpbmdzLmF1dG9SZW5hbWVGb2xkZXIpXHJcbiAgICAgICAgICAgIG5ldyBTZXR0aW5nKGNvbnRhaW5lckVsKVxyXG4gICAgICAgICAgICAuc2V0TmFtZSgnQXV0b21hdGljYWxseSByZW5hbWUgYXR0YWNobWVudCBmaWxlcyBbRXhwZXJpbWVudGFsXScpXHJcbiAgICAgICAgICAgIC5zZXREZXNjKCdXaGVuIHJlbmFtaW5nIG1kIGZpbGVzLCBhdXRvbWF0aWNhbGx5IHJlbmFtZSBhdHRhY2htZW50IGZpbGVzIGlmIGZpbGUgbmFtZSBjb250YWlucyBcIiR7ZmlsZW5hbWV9XCIuJylcclxuICAgICAgICAgICAgLmFkZFRvZ2dsZSh0b2dnbGUgPT4gdG9nZ2xlXHJcbiAgICAgICAgICAgICAgICAuc2V0VmFsdWUodGhpcy5wbHVnaW4uc2V0dGluZ3MuYXV0b1JlbmFtZUZpbGVzKVxyXG4gICAgICAgICAgICAgICAgLm9uQ2hhbmdlKGFzeW5jICh2YWx1ZTogYm9vbGVhbikgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMucGx1Z2luLnNldHRpbmdzLmF1dG9SZW5hbWVGaWxlcyA9IHZhbHVlO1xyXG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMucGx1Z2luLnNhdmVTZXR0aW5ncygpO1xyXG4gICAgICAgICAgICAgICAgfSkpO1xyXG4gICAgfVxyXG59XHJcbiJdLAogICJtYXBwaW5ncyI6ICI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7QUFBQTtBQUFBO0FBQUEsc0JBQTBKO0FBQzFKLFdBQXNCO0FBWXRCLElBQU0sbUJBQXFEO0FBQUEsRUFDdkQsc0JBQXNCO0FBQUEsRUFDdEIscUJBQXFCO0FBQUEsRUFDckIsZ0JBQWdCO0FBQUEsRUFDaEIsa0JBQWtCO0FBQUEsRUFDbEIsaUJBQWlCO0FBQUE7QUFHckIsSUFBSSxtQkFBbUI7QUFBQSxFQUNuQixzQkFBc0I7QUFBQTtBQUcxQixJQUFNLG9CQUFvQixDQUFDLFNBQWU7QUFDdEMsU0FBTyxJQUFJLFFBQVEsQ0FBQyxZQUFZO0FBQzlCLFVBQU0sU0FBUyxJQUFJO0FBQ25CLFdBQU8sWUFBWSxNQUFNLFFBQVEsT0FBTztBQUN4QyxXQUFPLGtCQUFrQjtBQUFBO0FBQUE7QUFLL0IsbUNBQTZCLE9BQU07QUFB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
